# File: .github/workflows/sync-from-upstream.yaml

name: Sync from Upstream

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to sync (e.g., master or develop)'
        required: true
  repository_dispatch:
    types: [sync-from-upstream]

env:
  ALLOWED_BRANCHES: 'master,develop'  # ‚úÖ Define allowed branches as a comma-separated list

jobs:
  validate-branch-if-manual:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.check.outputs.allowed }}
    steps:
      - name: Validate input branch
        id: check
        run: |
          BRANCH="${{ inputs.branch }}"
          echo "üîç Validating input branch: $BRANCH"

          IFS=',' read -ra ALLOWED_ARRAY <<< "${{ env.ALLOWED_BRANCHES }}"
          for allowed in "${ALLOWED_ARRAY[@]}"; do
            if [[ "$BRANCH" == "$allowed" ]]; then
              msg="‚úÖ Branch '$BRANCH' is allowed for manual sync."
              echo "$msg"
              echo "allowed=true" >> "$GITHUB_OUTPUT"
              echo "$msg"  # Repeat same message for clarity after Set output
              exit 0
            fi
          done

          msg="‚ùå Branch '$BRANCH' is not allowed for manual sync."
          echo "$msg"
          echo "allowed=false" >> "$GITHUB_OUTPUT"
          echo "$msg"  # Repeat same message again after Set output


          
  repo-sync:
    if: |
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'workflow_dispatch' && needs.validate-branch-if-manual.outputs.allowed == 'true')
    needs: [validate-branch-if-manual]
    uses: vaibhshah/common-actions/.github/workflows/repo-sync-v2.yaml@main
    with:
      source_repo: vaibhhvv/original-repo-3       # original repo name
      source_branch: ${{ github.event.client_payload.branch || inputs.branch }}
      fork_repo: vaibhshah/forked-repo-3
      destination_branch: feat-sync-${{ github.event.client_payload.branch || inputs.branch }}
      base_branch: ${{ github.event.client_payload.branch || inputs.branch }}
    secrets:
      PAT: ${{ secrets.PAT }}
